---
// Micro video thumbnail component for category pages
export interface Props {
  playbackId: string;
  title: string;
  description?: string;
  aspectRatio?: '16:9' | '4:3' | '1:1';
  size?: 'small' | 'medium' | 'large';
  autoplay?: boolean;
}

const {
  playbackId,
  title,
  description,
  aspectRatio = '16:9',
  size = 'medium',
  autoplay = false
} = Astro.props;

const muxEnvKey = "26hi0t52rcm3pl738jugp7sp8";

// Size configurations for optimal performance
const sizeConfig = {
  small: { width: 320, height: 180, maxRes: '360p' },
  medium: { width: 480, height: 270, maxRes: '480p' },
  large: { width: 640, height: 360, maxRes: '720p' }
};

const config = sizeConfig[size];
const aspectClass = aspectRatio === '1:1' ? 'aspect-square' : 
                   aspectRatio === '4:3' ? 'aspect-[4/3]' : 'aspect-video';
---

<div class={`relative ${aspectClass} overflow-hidden rounded-lg bg-gray-100 group cursor-pointer hover:shadow-lg transition-all duration-300`}>
  <!-- Ultra-optimized micro video player -->
  <mux-player
    playback-id={playbackId}
    metadata-video-title={title}
    env-key={muxEnvKey}
    muted
    loop={autoplay}
    playback-engine="mse"
    max-resolution={config.maxRes}
    style="width: 100%; height: 100%; object-fit: cover;"
    class="w-full h-full"
    poster={`https://image.mux.com/${playbackId}/thumbnail.webp?width=${config.width}&height=${config.height}&fit=crop&crop=smart&q=75`}
    preload="none"
    controls="false"
    default-hidden-captions="true"
    disable-cookies="true"
    data-thumbnail="true"
  >
  </mux-player>
  
  <!-- Play button overlay - only for non-autoplay videos -->
  {!autoplay && (
    <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-20 group-hover:bg-opacity-30 transition-colors">
      <div class="w-12 h-12 bg-white bg-opacity-90 rounded-full flex items-center justify-center shadow-lg transform group-hover:scale-110 transition-transform">
        <svg class="w-5 h-5 text-gray-800 ml-1" fill="currentColor" viewBox="0 0 20 20">
          <path d="M8 5v10l6-5z"/>
        </svg>
      </div>
    </div>
  )}
  
  <!-- No content overlay for autoplay thumbnails - clean video only -->
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const thumbnails = document.querySelectorAll('mux-player[data-thumbnail]');
    
    // Intersection observer for thumbnail loading
    if ('IntersectionObserver' in window) {
      const thumbnailObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const player = entry.target;
            
            // Click to play for non-autoplay thumbnails
            if (!player.hasAttribute('loop')) {
              player.parentElement.addEventListener('click', () => {
                player.play().catch(() => {
                  console.log('Thumbnail video play blocked');
                });
              });
            } else {
              // Auto-play for hover thumbnails after delay
              setTimeout(() => {
                player.play().catch(() => {});
              }, 1000);
            }
            
            thumbnailObserver.unobserve(player);
          }
        });
      }, {
        rootMargin: '50px',
        threshold: 0.3
      });
      
      thumbnails.forEach(thumbnail => {
        thumbnailObserver.observe(thumbnail);
      });
    }
    
    // Pause when not in view for battery optimization
    const pauseObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const player = entry.target;
        if (!entry.isIntersecting && player.hasAttribute('loop')) {
          player.pause();
        } else if (entry.isIntersecting && player.hasAttribute('loop')) {
          setTimeout(() => player.play().catch(() => {}), 500);
        }
      });
    }, {
      threshold: 0.1
    });
    
    thumbnails.forEach(thumbnail => {
      if (thumbnail.hasAttribute('loop')) {
        pauseObserver.observe(thumbnail);
      }
    });
  });
</script>

<style>
  /* Smooth hover animations */
  [data-thumbnail] {
    transition: transform 0.3s ease;
  }
  
  .group:hover [data-thumbnail] {
    transform: scale(1.02);
  }
  
  /* Loading state */
  [data-thumbnail]:not([data-loaded]) {
    background: linear-gradient(45deg, #f3f4f6 25%, #e5e7eb 25%, #e5e7eb 50%, #f3f4f6 50%, #f3f4f6 75%, #e5e7eb 75%);
    background-size: 20px 20px;
    animation: shimmer 2s infinite linear;
  }
  
  @keyframes shimmer {
    0% { background-position: 0 0; }
    100% { background-position: 40px 40px; }
  }
</style>