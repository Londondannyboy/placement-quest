---
// VideoHero component with Mux integration and performance optimization
export interface Props {
  desktopPlaybackId?: string;
  mobilePlaybackId?: string;
  title?: string;
  subtitle?: string;
  ctaText?: string;
  ctaLink?: string;
}

const {
  desktopPlaybackId = "ew9vFwrawM3Eq1MVGHUZwu4IPoFOHVv002Hal1ei02JXM", // Your Cyprus video (high-res desktop)
  mobilePlaybackId = "lKoMAX9eQ1aNdFc6squdJgBlkhBMUDjuq43tf00jZpik", // Your dedicated low-res mobile asset
  title = "Your Journey to Global Living Starts Here",
  subtitle = "Expert guidance on international relocation, visa applications, tax optimization, and building your dream life abroad.",
  ctaText = "Read Latest Articles",
  ctaLink = "/articles"
} = Astro.props;

const muxEnvKey = "26hi0t52rcm3pl738jugp7sp8";

// Generate optimized poster URLs
const desktopPoster = `https://image.mux.com/${desktopPlaybackId}/thumbnail.webp?width=1920&height=1080&fit=crop&crop=smart&q=75`;
const mobilePoster = `https://image.mux.com/${desktopPlaybackId}/thumbnail.webp?width=750&height=1334&fit=crop&crop=smart&q=50`;
---

<!-- Preload LCP poster image for faster loading -->
<link rel="preload" as="image" href={desktopPoster} fetchpriority="high" />

<!-- Ensure Mux Player loads properly for mobile -->
<script>
  // Load Mux Player with proper mobile support
  function loadMuxPlayer() {
    if (!window.customElements.get('mux-player')) {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@mux/mux-player@2';
      script.onload = () => {
        // Initialize video players after script loads
        setTimeout(() => {
          const players = document.querySelectorAll('mux-player');
          players.forEach(player => {
            // Ensure mobile-friendly autoplay
            if (window.innerWidth < 768) {
              player.setAttribute('autoplay', '');
              player.setAttribute('muted', '');
              player.setAttribute('playsinline', '');
            }
          });
        }, 100);
      };
      document.head.appendChild(script);
    }
  }
  
  // Load immediately for better mobile performance
  loadMuxPlayer();
</script>

<div class="relative min-h-screen overflow-hidden bg-gradient-to-br from-blue-600 to-orange-500">
  <!-- Fallback gradient background (maintains current design) -->
  
  <!-- Single Responsive Mux Player -->
  {desktopPlaybackId && (
    <div class="absolute inset-0">
      <mux-player
        playback-id={desktopPlaybackId}
        metadata-video-title="Relocation Quest - Cyprus International Relocation"
        metadata-video-id={desktopPlaybackId}
        metadata-viewer-user-id="hero-banner-responsive"
        env-key={muxEnvKey}
        autoplay
        muted
        loop
        playsinline
        style="width: 100%; height: 100%; object-fit: cover;"
        class="w-full h-full"
        poster={desktopPoster}
        preload="metadata"
        controls="false"
        default-hidden-captions="true"
        disable-cookies="true"
        responsive-width="100%"
        responsive-height="100%"
      >
      </mux-player>
    </div>
  )}
  
  <!-- Dark overlay for text readability -->
  <div class="absolute inset-0 bg-black bg-opacity-40"></div>
  
  <!-- Content Overlay -->
  <div class="relative z-10 flex items-center justify-center min-h-screen">
    <div class="text-center text-white max-w-4xl px-4 sm:px-6 lg:px-8">
      <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold mb-4 leading-tight">
        {title}
      </h1>
      <p class="text-lg sm:text-xl md:text-2xl mb-8 max-w-3xl mx-auto leading-relaxed">
        {subtitle}
      </p>
      <a 
        href={ctaLink}
        class="inline-block bg-white text-blue-600 px-8 py-4 rounded-full font-semibold text-lg hover:bg-gray-100 transition-all duration-300 transform hover:scale-105 shadow-lg"
      >
        {ctaText}
      </a>
    </div>
  </div>
  
  <!-- Maximum Performance Optimization -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const players = document.querySelectorAll('mux-player');
      
      // Advanced performance optimization
      function optimizePlayer(player) {
        // Ultra-aggressive mobile optimization
        const isMobile = player.classList.contains('md:hidden');
        
        // Check battery and connection for mobile optimization
        if (isMobile) {
          // Skip video on low battery
          if ('getBattery' in navigator) {
            navigator.getBattery().then(battery => {
              if (battery.level < 0.2 || !battery.charging) {
                player.style.display = 'none';
                return;
              }
            });
          }
          
          // Skip video on very slow connections
          if ('connection' in navigator && 'effectiveType' in navigator.connection) {
            const conn = navigator.connection;
            if (conn.effectiveType === 'slow-2g' || conn.effectiveType === '2g') {
              player.style.display = 'none';
              return;
            }
          }
        }
        
        if ('connection' in navigator && 'effectiveType' in navigator.connection) {
          const conn = navigator.connection;
          
          // Adaptive buffer settings based on connection
          player.addEventListener('loadstart', () => {
            if (player._hls) {
              switch (conn.effectiveType) {
                case '3g':
                  player._hls.config.maxBufferLength = 8; // Reduced for mobile
                  if (isMobile) {
                    player.setAttribute('max-resolution', '360p');
                  }
                  break;
                case '4g':
                  player._hls.config.maxBufferLength = isMobile ? 12 : 25;
                  break;
                default:
                  player._hls.config.maxBufferLength = isMobile ? 15 : 30;
              }
            }
          });
        }
        
        // Performance monitoring
        player.addEventListener('loadeddata', () => {
          console.log('Mux Player loaded:', player.getAttribute('metadata-video-title'));
        });
        
        // Error handling
        player.addEventListener('error', (e) => {
          console.error('Mux Player error:', e.detail);
        });
      }
      
      // Advanced Intersection Observer for lazy loading
      if ('IntersectionObserver' in window) {
        const playerObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const player = entry.target;
              
              // Initialize player only when visible
              optimizePlayer(player);
              
              // Ultra-aggressive delay for mobile performance, moderate for desktop
              const delay = player.classList.contains('md:hidden') ? 5000 : 1000;
              setTimeout(() => {
                if (player.hasAttribute('autoplay')) {
                  player.play().catch(() => {
                    console.log('Autoplay blocked, user interaction required');
                  });
                }
              }, delay);
              
              playerObserver.unobserve(player);
            }
          });
        }, {
          rootMargin: '200px',
          threshold: 0.05
        });
        
        players.forEach(player => {
          playerObserver.observe(player);
        });
      }
      
      // Respect reduced motion and battery optimization
      if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        players.forEach(player => {
          player.removeAttribute('autoplay');
          player.style.display = 'none';
        });
      }
      
      // Page visibility optimization for battery life
      document.addEventListener('visibilitychange', function() {
        players.forEach(player => {
          if (document.visibilityState === 'hidden') {
            player.pause();
          } else if (player.hasAttribute('autoplay')) {
            setTimeout(() => player.play().catch(() => {}), 500);
          }
        });
      });
    });
  </script>
</div>

<style>
  /* Ensure video covers container properly */
  video {
    object-fit: cover;
    width: 100%;
    height: 100%;
  }
  
  /* Smooth transitions for CTA button */
  a {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Loading state for videos */
  video:not([data-loaded]) {
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }
  
  video[data-loaded] {
    opacity: 1;
  }
  
  /* Accessibility: Respect reduced motion */
  @media (prefers-reduced-motion: reduce) {
    video {
      display: none !important;
    }
  }
</style>