---
// VideoHero component with Mux integration and performance optimization
export interface Props {
  desktopPlaybackId?: string;
  mobilePlaybackId?: string;
  title?: string;
  subtitle?: string;
  ctaText?: string;
  ctaLink?: string;
}

const {
  desktopPlaybackId = "ew9vFwrawM3Eq1MVGHUZwu4IPoFOHVv002Hal1ei02JXM", // Your Cyprus video (confirmed public)
  mobilePlaybackId = "ew9vFwrawM3Eq1MVGHUZwu4IPoFOHVv002Hal1ei02JXM", // Same video, Mux will optimize for mobile
  title = "Your Journey to Global Living Starts Here",
  subtitle = "Expert guidance on international relocation, visa applications, tax optimization, and building your dream life abroad.",
  ctaText = "Read Latest Articles",
  ctaLink = "/articles"
} = Astro.props;

const muxEnvKey = "26hi0t52rcm3pl738jugp7sp8";
---

<div class="relative min-h-screen overflow-hidden bg-gradient-to-br from-blue-600 to-orange-500">
  <!-- Fallback gradient background (maintains current design) -->
  
  <!-- Maximum Performance Mux Player -->
  {desktopPlaybackId && (
    <div class="absolute inset-0">
      <!-- Desktop: High Quality -->
      <mux-player
        playback-id={desktopPlaybackId}
        metadata-video-title="Relocation Quest - Cyprus International Relocation"
        metadata-video-id={desktopPlaybackId}
        metadata-viewer-user-id="hero-banner"
        env-key={muxEnvKey}
        autoplay
        muted
        loop
        playback-engine="mse"
        max-resolution="1080p"
        min-resolution="720p"
        style="width: 100%; height: 100%; object-fit: cover;"
        class="w-full h-full hidden md:block"
        poster={`https://image.mux.com/${desktopPlaybackId}/thumbnail.webp?width=1920&height=1080&fit=crop&crop=smart&q=80`}
        preload="none"
        controls="false"
        default-hidden-captions="true"
        disable-cookies="true"
        extra-source-params="redundant_streams=true"
      >
      </mux-player>
      
      <!-- Mobile: Optimized for Performance -->
      <mux-player
        playback-id={mobilePlaybackId}
        metadata-video-title="Relocation Quest Mobile - Cyprus Relocation"
        metadata-video-id={mobilePlaybackId}
        metadata-viewer-user-id="hero-banner-mobile"
        env-key={muxEnvKey}
        autoplay
        muted
        loop
        playback-engine="mse"
        max-resolution="720p"
        min-resolution="480p"
        style="width: 100%; height: 100%; object-fit: cover;"
        class="w-full h-full md:hidden"
        poster={`https://image.mux.com/${mobilePlaybackId}/thumbnail.webp?width=750&height=1334&fit=crop&crop=smart&q=70`}
        preload="none"
        controls="false"
        default-hidden-captions="true"
        disable-cookies="true"
        target-live-window="10"
      >
      </mux-player>
    </div>
  )}
  
  <!-- Dark overlay for text readability -->
  <div class="absolute inset-0 bg-black bg-opacity-40"></div>
  
  <!-- Content Overlay -->
  <div class="relative z-10 flex items-center justify-center min-h-screen">
    <div class="text-center text-white max-w-4xl px-4 sm:px-6 lg:px-8">
      <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold mb-4 leading-tight">
        {title}
      </h1>
      <p class="text-lg sm:text-xl md:text-2xl mb-8 max-w-3xl mx-auto leading-relaxed">
        {subtitle}
      </p>
      <a 
        href={ctaLink}
        class="inline-block bg-white text-blue-600 px-8 py-4 rounded-full font-semibold text-lg hover:bg-gray-100 transition-all duration-300 transform hover:scale-105 shadow-lg"
      >
        {ctaText}
      </a>
    </div>
  </div>
  
  <!-- Maximum Performance Optimization -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const players = document.querySelectorAll('mux-player');
      
      // Advanced performance optimization
      function optimizePlayer(player) {
        // Check connection quality for adaptive settings
        if ('connection' in navigator && 'effectiveType' in navigator.connection) {
          const conn = navigator.connection;
          const isMobile = player.classList.contains('md:hidden');
          
          // Adaptive buffer settings based on connection
          player.addEventListener('loadstart', () => {
            if (player._hls) {
              switch (conn.effectiveType) {
                case 'slow-2g':
                case '2g':
                  player._hls.config.maxBufferLength = 10;
                  if (isMobile) {
                    player.setAttribute('max-resolution', '360p');
                  }
                  break;
                case '3g':
                  player._hls.config.maxBufferLength = 20;
                  break;
                default:
                  player._hls.config.maxBufferLength = 30;
              }
            }
          });
        }
        
        // Performance monitoring
        player.addEventListener('loadeddata', () => {
          console.log('Mux Player loaded:', player.getAttribute('metadata-video-title'));
        });
        
        // Error handling
        player.addEventListener('error', (e) => {
          console.error('Mux Player error:', e.detail);
        });
      }
      
      // Advanced Intersection Observer for lazy loading
      if ('IntersectionObserver' in window) {
        const playerObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const player = entry.target;
              
              // Initialize player only when visible
              optimizePlayer(player);
              
              // Start loading after a small delay for critical path optimization
              setTimeout(() => {
                if (player.hasAttribute('autoplay')) {
                  player.play().catch(() => {
                    console.log('Autoplay blocked, user interaction required');
                  });
                }
              }, player.classList.contains('md:hidden') ? 1000 : 300);
              
              playerObserver.unobserve(player);
            }
          });
        }, {
          rootMargin: '100px',
          threshold: 0.1
        });
        
        players.forEach(player => {
          playerObserver.observe(player);
        });
      }
      
      // Respect reduced motion and battery optimization
      if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        players.forEach(player => {
          player.removeAttribute('autoplay');
          player.style.display = 'none';
        });
      }
      
      // Page visibility optimization for battery life
      document.addEventListener('visibilitychange', function() {
        players.forEach(player => {
          if (document.visibilityState === 'hidden') {
            player.pause();
          } else if (player.hasAttribute('autoplay')) {
            setTimeout(() => player.play().catch(() => {}), 500);
          }
        });
      });
    });
  </script>
</div>

<style>
  /* Ensure video covers container properly */
  video {
    object-fit: cover;
    width: 100%;
    height: 100%;
  }
  
  /* Smooth transitions for CTA button */
  a {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Loading state for videos */
  video:not([data-loaded]) {
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }
  
  video[data-loaded] {
    opacity: 1;
  }
  
  /* Accessibility: Respect reduced motion */
  @media (prefers-reduced-motion: reduce) {
    video {
      display: none !important;
    }
  }
</style>